<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="Ridwan Syarif Setiawan" />
        <title>Bus Intelligence Core</title>
        <meta name="description" content="Three.js">
        <style>
            body {
                overflow: hidden;
                margin: 0px;
                background-color: #2c3e50; /* Dark blue-grey for a modern feel */
                color: #ecf0f1; /* Light grey for contrast */
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                display: flex;
                flex-direction: column; /* Arrange content vertically */
                height: 100vh; /* Full viewport height */
            }

            #progressBar {
                width: 500px;
                height: 24px;
                position: absolute;
                left: 50%;
                top: 10px;
                margin-left: -250px;
                z-index: 100;
                transition: opacity 0.5s ease-out;
                background-color: #34495e;
                border-radius: 5px;
            }
            #progressBar::-webkit-progress-bar {
                background-color: #34495e;
                border-radius: 5px;
            }
            #progressBar::-webkit-progress-value {
                background-color: #27ae60;
                border-radius: 5px;
            }
            #progressBar::-moz-progress-bar {
                background-color: #27ae60;
                border-radius: 5px;
            }
            
            /* Header Dashboard */
            #headerDashboard {
                width: calc(100% - 40px); /* Full width minus side padding */
                background-color: rgba(44, 62, 80, 0.9);
                padding: 15px 20px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
                z-index: 100;
                display: flex;
                justify-content: space-around; /* Distribute items evenly */
                align-items: center;
                border-bottom-left-radius: 15px;
                border-bottom-right-radius: 15px;
                margin-bottom: 20px; /* Space between header and 3D model */
                flex-shrink: 0; /* Prevent it from shrinking */
            }

            .header-info-item {
                text-align: center;
                flex-grow: 1; /* Allows items to grow and fill space */
                padding: 0 10px;
            }

            .header-info-item strong {
                display: block; /* Make label appear above value */
                font-size: 0.9em;
                color: #bdc3c7;
                margin-bottom: 5px;
            }

            .header-info-item span {
                font-size: 1.4em;
                font-weight: bold;
                color: #27ae60; /* Green accent for values */
            }

            /* Main content area (for 3D model) */
            #mainContent {
                flex-grow: 1; /* Takes up remaining space */
                position: relative; /* For the 3D canvas */
            }

            /* Control Panel (right side) */
            #controlPanel {
                position: absolute;
                top: 0; /* Position relative to mainContent */
                right: 20px;
                background-color: rgba(44, 62, 80, 0.8);
                border-radius: 15px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
                padding: 25px;
                z-index: 100;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                max-width: 300px;
                border: 1px solid rgba(52, 73, 94, 0.7);
            }
            
            #controlPanel h3 {
                margin-top: 0;
                margin-bottom: 20px;
                color: #ecf0f1;
                text-align: center;
                font-size: 1.8em;
                letter-spacing: 1px;
                text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            }
            
            .control-btn {
                display: block;
                width: 100%;
                padding: 12px 15px;
                margin-bottom: 12px;
                background-color: #3498db;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 1.1em;
                font-weight: bold;
                transition: background-color 0.3s ease, transform 0.1s ease;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            }
            
            .control-btn:hover {
                background-color: #2980b9;
                transform: translateY(-2px);
            }
            
            .control-btn:active {
                background-color: #2c3e50;
                transform: translateY(0);
            }
            
            .control-btn:last-child {
                margin-bottom: 0;
            }
            
            /* Modal styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 200;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .modal-content {
                background-color: #34495e;
                margin: auto;
                padding: 30px;
                border-radius: 15px;
                width: 90%;
                max-width: 550px;
                box-shadow: 0 10px 20px rgba(0,0,0,0.5);
                color: #ecf0f1;
                position: relative;
                border: 1px solid rgba(52, 73, 94, 0.7);
            }
            
            .modal-content h2 {
                margin-top: 0;
                margin-bottom: 20px;
                color: #27ae60;
                text-align: center;
                font-size: 1.5em;
                border-bottom: 2px solid #27ae60;
                padding-bottom: 10px;
            }

            .modal-content p {
                margin-bottom: 10px;
                font-size: 1.1em;
                line-height: 1.6;
            }

            .modal-content .status-item {
                display: flex;
                justify-content: space-between;
                padding: 8px 0;
                border-bottom: 1px dashed rgba(236, 240, 241, 0.2);
            }

            .modal-content .status-item:last-child {
                border-bottom: none;
            }

            .modal-content .status-item span:first-child {
                font-weight: bold;
                color: #bdc3c7;
            }
            .modal-content .status-item span:last-child {
                color: #f1c40f;
            }
            .modal-content .status-item.announcement {
                text-align: center;
                font-style: italic;
                color: #ecf0f1;
                background-color: rgba(39, 174, 96, 0.3);
                padding: 15px;
                border-radius: 8px;
                margin-top: 20px;
                border: 1px solid #27ae60;
            }
            
            .close {
                color: #bdc3c7;
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 32px;
                font-weight: bold;
                cursor: pointer;
                transition: color 0.3s ease;
            }
            
            .close:hover {
                color: #e74c3c;
            }
        </style>        
        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.132.2/examples/jsm/"
                }
            }
        </script>
    </head>
    <body>
        <progress value="0" max="100" id="progressBar"></progress>
        
        <div id="headerDashboard">
            <div class="header-info-item">
                <strong>Kecepatan Bus</strong>
                <span id="busSpeed">0 km/jam</span>
            </div>
            <div class="header-info-item">
                <strong>Lokasi Bus</strong>
                <span id="busLocation">Loading...</span>
            </div>
            <div class="header-info-item">
                <strong>Suhu Mesin</strong>
                <span id="engineTemp">-- 째C</span>
            </div>
            <div class="header-info-item">
                <strong>Suhu Kabin</strong>
                <span id="cabinTemp">-- 째C</span>
            </div>
        </div>

        <div id="mainContent">
            <div id="controlPanel">
                <h3>Bus Controls</h3>
                <button class="control-btn" id="doorStatusBtn">Door Status</button>
                <button class="control-btn" id="passengerListBtn">Passenger List</button>
                <button class="control-btn" id="lightStatusBtn">Light Status</button>
                <button class="control-btn" id="driverAnnouncementBtn">Driver Announcement</button>
            </div>
        </div>
        
        <div id="doorStatusModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Door Status</h2>
                <div class="status-item"><span>Front Door:</span> <span id="frontDoorStatus">Closed</span></div>
                <div class="status-item"><span>Middle Door:</span> <span id="middleDoorStatus">Closed</span></div>
                <div class="status-item"><span>Rear Door:</span> <span id="rearDoorStatus">Closed</span></div>
                <div class="status-item"><span>Emergency Exits:</span> <span id="emergencyExitStatus">All Secure</span></div>
            </div>
        </div>
        
        <div id="passengerListModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Passenger List</h2>
                <div class="status-item"><span>Total Passengers:</span> <span id="totalPassengers">24</span></div>
                <div class="status-item"><span>Seated:</span> <span id="seatedPassengers">20</span></div>
                <div class="status-item"><span>Standing:</span> <span id="standingPassengers">4</span></div>
                <div class="status-item"><span>Special Needs:</span> <span id="specialNeedsPassengers">2</span></div>
            </div>
        </div>
        
        <div id="lightStatusModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Light Status</h2>
                <div class="status-item"><span>Interior Lights:</span> <span id="interiorLights">On</span></div>
                <div class="status-item"><span>Headlights:</span> <span id="headlights">On</span></div>
                <div class="status-item"><span>Brake Lights:</span> <span id="brakeLights">Off</span></div>
                <div class="status-item"><span>Turn Signals:</span> <span id="turnSignals">Off</span></div>
                <div class="status-item"><span>Emergency Lights:</span> <span id="emergencyLights">Off</span></div>
            </div>
        </div>

        <div id="driverAnnouncementModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2>Driver Announcement</h2>
                <div class="status-item announcement" id="announcementText">
                    "Selamat datang para penumpang. Bus akan segera berangkat. Mohon siapkan karcis atau kartu pembayaran Anda. Terima kasih."
                </div>
            </div>
        </div>
        
        <script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
            import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
            import Stats from 'https://ridwan89.github.io/3d-web/stats.module.js';

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x2c3e50); // Dark blue-grey for 3D background

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.4);
            directionalLight1.position.set(5, 10, 7.5);
            directionalLight1.castShadow = true;
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.3);
            directionalLight2.position.set(-5, -10, -7.5);
            scene.add(directionalLight2);
            
            const hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x000000, 0.3);
            scene.add(hemisphereLight);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.x = 0;
            camera.position.y = 0;
            camera.position.z = 10;

            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setClearColor(0x2c3e50, 1);
            
            // Append renderer to the mainContent div, not body directly
            document.getElementById('mainContent').appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.maxPolarAngle = Math.PI / 2; 
            controls.enableZoom = false;
            controls.enablePan = false;

            const progressBar = document.getElementById('progressBar');

            const objLoader = new OBJLoader();
            objLoader.load(
                'https://ridwan89.github.io/3d-web/model.obj',
                (object) => {
                    progressBar.style.opacity = '0';
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                    }, 500);
                    
                    const grayMaterial = new THREE.MeshStandardMaterial({
                        color: 0x7f8c8d,
                        roughness: 0.8,
                        metalness: 0.1,
                        side: THREE.DoubleSide,
                        transparent: true,
                        opacity: 0
                    });

                    object.traverse(function(child) {
                        if (child.isMesh) {
                            child.material = grayMaterial;
                            child.castShadow = true;
                            child.receiveShadow = false;
                            child.geometry.computeVertexNormals();
                        }
                    });
                    
                    const box = new THREE.Box3().setFromObject(object);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());
                    
                    object.position.sub(center);
                    
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const fov = camera.fov * (Math.PI / 180);
                    let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                    cameraZ *= 1.2;
                    
                    const targetCameraPosition = new THREE.Vector3(
                        cameraZ * 0.7, 
                        cameraZ * 0.5, 
                        cameraZ
                    );
                    
                    const startCameraPosition = new THREE.Vector3(
                        0, 
                        0, 
                        cameraZ * 2.5
                    );
                    
                    camera.position.copy(startCameraPosition);
                    camera.lookAt(0, 0, 0);
                    controls.update();
                    
                    scene.add(object);
                    
                    let opacity = 0;
                    const spinDuration = 2000;
                    const moveDuration = 1000;
                    const totalDuration = spinDuration + moveDuration;
                    const animationStartTime = Date.now();
                    
                    let spinProgress = 0;
                    let moveProgress = 0;
                    
                    const animateIntro = () => {
                        const elapsed = Date.now() - animationStartTime;
                        const totalProgress = Math.min(elapsed / totalDuration, 1);
                        
                        if (elapsed < spinDuration) {
                            spinProgress = elapsed / spinDuration;
                            moveProgress = 0;
                            
                            const angle = spinProgress * Math.PI * 2;
                            const radius = cameraZ * 2.5;
                            camera.position.x = Math.sin(angle) * radius;
                            camera.position.z = Math.cos(angle) * radius;
                            camera.position.y = radius * 0.3;
                            camera.lookAt(0, 0, 0);
                            
                            opacity = spinProgress * 0.8;
                        } else {
                            spinProgress = 1;
                            moveProgress = (elapsed - spinDuration) / moveDuration;
                            
                            const spinEndPosition = new THREE.Vector3(
                                Math.sin(Math.PI * 2) * cameraZ * 2.5,
                                cameraZ * 2.5 * 0.3,
                                Math.cos(Math.PI * 2) * cameraZ * 2.5
                            );
                            
                            camera.position.lerpVectors(
                                spinEndPosition,
                                targetCameraPosition,
                                moveProgress
                            );
                            camera.lookAt(0, 0, 0);
                            
                            opacity = 0.8 + (moveProgress * 0.2);
                        }
                        
                        object.traverse(function(child) {
                            if (child.isMesh) {
                                child.material.opacity = opacity;
                            }
                        });
                        
                        if (totalProgress < 1) {
                            requestAnimationFrame(animateIntro);
                        } else {
                            controls.enabled = true;
                        }
                    };
                    
                    controls.enabled = false;
                    animateIntro();
                },
                (xhr) => {
                    if (xhr.lengthComputable) {
                        var percentComplete = (xhr.loaded / xhr.total) * 100;
                        progressBar.value = percentComplete;
                        progressBar.style.display = 'block';
                    }
                },
                (error) => {
                    console.error('Error loading OBJ:', error);
                    progressBar.style.opacity = '0';
                    setTimeout(() => {
                        progressBar.style.display = 'none';
                    }, 500);
                }
            );

            function onWindowResize() {
                // Adjust renderer size to fill the mainContent div
                const mainContent = document.getElementById('mainContent');
                camera.aspect = mainContent.clientWidth / mainContent.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(mainContent.clientWidth, mainContent.clientHeight);
                render();
            }
            window.addEventListener('resize', onWindowResize, false);

            const stats = new Stats();
            document.body.appendChild(stats.dom); // Keep stats for overall performance

            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                render();
                stats.update();
            }

            function render() {
                renderer.render(scene, camera);
            }

            animate();
            
            // Modal functionality
            const doorStatusBtn = document.getElementById("doorStatusBtn");
            const passengerListBtn = document.getElementById("passengerListBtn");
            const lightStatusBtn = document.getElementById("lightStatusBtn");
            const driverAnnouncementBtn = document.getElementById("driverAnnouncementBtn");

            const doorStatusModal = document.getElementById("doorStatusModal");
            const passengerListModal = document.getElementById("passengerListModal");
            const lightStatusModal = document.getElementById("lightStatusModal");
            const driverAnnouncementModal = document.getElementById("driverAnnouncementModal");
            
            const closeButtons = document.getElementsByClassName("close");
            
            doorStatusBtn.onclick = function() {
                doorStatusModal.style.display = "flex";
            }
            
            passengerListBtn.onclick = function() {
                passengerListModal.style.display = "flex";
            }
            
            lightStatusBtn.onclick = function() {
                lightStatusModal.style.display = "flex";
            }

            driverAnnouncementBtn.onclick = function() {
                driverAnnouncementModal.style.display = "flex";
            }
            
            for (let i = 0; i < closeButtons.length; i++) {
                closeButtons[i].onclick = function() {
                    this.parentElement.parentElement.style.display = "none";
                }
            }
            
            window.onclick = function(event) {
                if (event.target == doorStatusModal) {
                    doorStatusModal.style.display = "none";
                }
                if (event.target == passengerListModal) {
                    passengerListModal.style.display = "none";
                }
                if (event.target == lightStatusModal) {
                    lightStatusModal.style.display = "none";
                }
                if (event.target == driverAnnouncementModal) {
                    driverAnnouncementModal.style.display = "none";
                }
            }

            // Function to simulate real-time data and update dashboard
            function updateBusData() {
                // Simulate data
                const speed = Math.floor(Math.random() * 80) + 10;
                const latitude = -6.917464 + (Math.random() - 0.5) * 0.05;
                const longitude = 107.619123 + (Math.random() - 0.5) * 0.05;
                const engineTemp = Math.floor(Math.random() * (100 - 70 + 1)) + 70;
                const cabinTemp = Math.floor(Math.random() * (30 - 20 + 1)) + 20;
                const announcements = [
                    "Selamat datang para penumpang. Bus akan segera berangkat. Mohon siapkan karcis atau kartu pembayaran Anda. Terima kasih.",
                    "Perhatian, halte selanjutnya adalah Terminal Leuwi Panjang. Bagi penumpang yang akan turun, harap bersiap.",
                    "Mohon jaga kebersihan dan keamanan di dalam bus. Terima kasih atas kerja samanya.",
                    "Mohon maaf atas keterlambatan, ada sedikit kemacetan di depan. Terima kasih atas pengertiannya.",
                    "Bagi penumpang yang merasa tidak enak badan, silakan beritahu pengemudi atau petugas.",
                    "Perjalanan akan dilanjutkan setelah istirahat singkat di rest area."
                ];
                const randomAnnouncement = announcements[Math.floor(Math.random() * announcements.length)];


                // Update dashboard info in header
                document.getElementById("busSpeed").textContent = `${speed} km/jam`;
                document.getElementById("engineTemp").textContent = `${engineTemp} 째C`;
                document.getElementById("cabinTemp").textContent = `${cabinTemp} 째C`;
                document.getElementById("announcementText").textContent = randomAnnouncement;

                // Update location and translate to geolocation name
                document.getElementById("busLocation").textContent = `(${latitude.toFixed(6)}, ${longitude.toFixed(6)})`; // Show coordinates first
                getGeolocationName(latitude, longitude).then(locationName => {
                    document.getElementById("busLocation").textContent = `${locationName}`; // Then update with name
                }).catch(error => {
                    console.error("Error getting geolocation name:", error);
                    document.getElementById("busLocation").textContent = `(${latitude.toFixed(6)}, ${longitude.toFixed(6)}) - Lokasi tidak ditemukan`;
                });

                // Simulate door status changes
                const doorStatuses = ["Open", "Closed"];
                document.getElementById("frontDoorStatus").textContent = doorStatuses[Math.floor(Math.random() * doorStatuses.length)];
                document.getElementById("middleDoorStatus").textContent = doorStatuses[Math.floor(Math.random() * doorStatuses.length)];
                document.getElementById("rearDoorStatus").textContent = doorStatuses[Math.floor(Math.random() * doorStatuses.length)];

                // Simulate light status changes
                const lightStates = ["On", "Off"];
                document.getElementById("interiorLights").textContent = lightStates[Math.floor(Math.random() * lightStates.length)];
                document.getElementById("headlights").textContent = lightStates[Math.floor(Math.random() * lightStates.length)];
                document.getElementById("brakeLights").textContent = lightStates[Math.floor(Math.random() * lightStates.length)];
                document.getElementById("turnSignals").textContent = lightStates[Math.floor(Math.random() * lightStates.length)];
                document.getElementById("emergencyLights").textContent = lightStates[Math.floor(Math.random() * lightStates.length)];

                 // Simulate passenger changes
                document.getElementById("totalPassengers").textContent = Math.floor(Math.random() * 50) + 1;
                document.getElementById("seatedPassengers").textContent = Math.floor(Math.random() * 40) + 1;
                document.getElementById("standingPassengers").textContent = Math.floor(Math.random() * 10) + 1;
                document.getElementById("specialNeedsPassengers").textContent = Math.floor(Math.random() * 3);
            }

            // Function to translate coordinates to geolocation name (using OpenCage Geocoding API)
            async function getGeolocationName(lat, lon) {
                // IMPORTANT: Replace 'YOUR_OPENCAGE_API_KEY' with your actual OpenCage API Key
                // You can get a free API key at https://opencagedata.com/
                const apiKey = 'YOUR_OPENCAGE_API_KEY'; 
                const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${apiKey}&pretty=1`;

                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.results && data.results.length > 0) {
                        // Prioritize relevant location names, e.g., city, road, etc.
                        const components = data.results[0].components;
                        if (components.city) return components.city;
                        if (components.town) return components.town;
                        if (components.village) return components.village;
                        if (components.road) return components.road;
                        if (data.results[0].formatted) return data.results[0].formatted;
                        return "Lokasi tidak diketahui";
                    } else {
                        return "Lokasi tidak diketahui";
                    }
                } catch (error) {
                    console.error("Error fetching geolocation:", error);
                    return "Error fetching lokasi";
                }
            }

            // Update data every 3 seconds
            setInterval(updateBusData, 3000);
            updateBusData(); // Initial call to populate data on load

            // Ensure the renderer resizes correctly immediately after load
            window.onload = () => {
                onWindowResize();
            };
        </script>
    </body>
</html>
